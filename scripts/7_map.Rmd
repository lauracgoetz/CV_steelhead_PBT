---
title: "7_CVSH: Map"
output: html_notebook
---

```{r}
library(rgdal)
library(sf)
library(tidyverse)
library(ggspatial)
library(raster)

library(maps)
library(mapdata)

library(ggplot2)
library(ggrepel)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
#library(googleway)

#library(ggmap)
library(spData)

```

shapefiles for major rivers, creeks, lakes, and reservoirs are available from the USGS National Hydrography Dataset (NHD)[https://data.cnra.ca.gov/dataset/nhd-major-features] and here[https://www.sciencebase.gov/catalog/item/61f8b88dd34e622189c32890]

Zoom into: xlim = c(-124.00, -120.00), ylim = c(37.00, 41.00)

### Hatchery Lat/Long from Google Maps
* Major rivers - Sacramento and San Joaquin Rivers
* CH- Battle Creek, Shasta dam/lake:  40.400914, -122.144753
* FRH- Feather River, Oroville dam/lake: 39.518446, -121.553234
* MRH- Mokelumne River, Camanche dam/lake: 38.225070, -121.024417
* NH- American River, Nimbus dam/Natoma lake:  38.633636, -121.224950

```{r}
# hatchery locations
hatcheries <- data.frame(Hatchery = c("CH", "FRH", "MRH", "NH"),
                              lat = 
                           c(40.400914,39.518446,38.225070,38.633636),
                              long = 
                           c(-122.144753,-121.553234,-121.024417,
                                            -121.224950))
```










```{r}
NHD1 <- readOGR(dsn = "../additional/NHD_Major_Rivers_and_Creeks/NHD_Major_Rivers_and_Creeks.shp", stringsAsFactors = F)
NHD2 <- readOGR(dsn = "../additional/NHD_Major_Rivers/NHD_Major_Rivers.shp", stringsAsFactors = F)
NHD3 <- readOGR(dsn = "../additional/NHD_Major_Lakes_and_Reservoirs/NHD_Major_Lakes_and_Reservoirs.shp", stringsAsFactors = F)
```

```{r}
NHD4 <- readOGR(dsn = "../additional/NHD_H_California_State_Shape/Shape/NHDArea.shp", stringsAsFactors = F)
ggNHD4 <- fortify(NHD4)
```

```{r}
ggNHD4_use <- ggNHD4 %>% 
  filter(long > -122.1 & long <= -121.8 & lat > 37.8 & lat <= 38.2)
```

# old
```{r}
ggNHD4_use <- ggNHD4 %>% 
  filter(long > -122.8 & long <= -120.5 & lat > 37.8 & lat <= 40.8) %>% 
  filter(!(long > -122.8 & long <= -122.1 & lat > 37.8 & lat <= 38.55)) %>% 
  filter(!(long > -121.4 & long <= -120 & lat > 40.1 & lat <= 41))
```



```{r}
NHD5 <- readOGR(dsn = "../additional/NHD_H_California_State_Shape/Shape/NHDPoint.shp", stringsAsFactors = F)


testNHD5 <- NHD5
ggNHD5 <-fortify(testNHD5)
```


```{r}
crks <- as.data.frame(NHD1@data[["gnis_name"]]) %>% 
  distinct()
saveNHD1 <- as.data.frame(NHD1@data[["gnis_name"]]) %>% 
  mutate(gnis_name = NHD1@data[["gnis_name"]]) %>% 
  dplyr::select(gnis_name) %>% 
  distinct() %>% 
  filter(str_detect(gnis_name, "American River|Battle Creek|Feather River|Mokelumne River|Sacramento|San Joaquin|Sutter")) %>% 
  filter(!str_detect(gnis_name, "Channel"))
testNHD1 <- NHD1 %>% subset(., gnis_name %in% saveNHD1$gnis_name)
ggNHD1 <-fortify(testNHD1)
```
"American River|Battle Creek|Feather River|Mokelumne River|San Joaquin|Sacramento|Smith Canal|Prospect"

```{r}
saveNHD2 <- as.data.frame(NHD2@data[["gnis_name"]]) %>% 
  mutate(gnis_name = NHD2@data[["gnis_name"]]) %>% 
  select(gnis_name) %>% 
  distinct() %>% 
  filter(str_detect(gnis_name, "River"))
testNHD2 <- NHD2 %>% subset(., gnis_name %in% saveNHD2$gnis_name)
ggNHD2 <-fortify(testNHD2)
```
"American|Feather|Mokelumne|San Joaquin|Sacramento|Smith River|Delta"

```{r}
saveNHD3 <- as.data.frame(NHD3@data[["gnis_name"]]) %>% 
  mutate(gnis_name = NHD3@data[["gnis_name"]]) %>% 
  select(gnis_name) %>% 
  distinct() %>% 
  filter(str_detect(gnis_name, "Camache|Oroville|Shasta|Natoma|Sherman"))
testNHD3 <- NHD3 %>% subset(., gnis_name %in% saveNHD3$gnis_name)
ggNHD3 <-fortify(testNHD3)
```


Extract relevant coordinates from NHD datasets

NHD1 = major rivers and creeks
* str_detect(gnis_name, "Battle Creek")
* str_detect(gnis_name, "Feather")
* str_detect(gnis_name, "Mokelumne")
* str_detect(gnis_name, "Nimbus")
* str_detect(gnis_name, "San Joaquin")
* str_detect(gnis_name, "Sacramento")

NHD2 = major rivers
* str_detect(gnis_name, "Battle Creek")
* str_detect(gnis_name, "Feather")
* str_detect(gnis_name, "Mokelumne")
* str_detect(gnis_name, "Nimbus")
* str_detect(gnis_name, "San Joaquin")
* str_detect(gnis_name, "Sacramento")

NHD3 = lakes and reservoirs
* str_detect(gnis_name, "Shasta")
* str_detect(gnis_name, "Oroville")
* str_detect(gnis_name, "Camanche")
* str_detect(gnis_name, "Natoma")


```{r}
states <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE))

pt1<- ggplot(data = states) + 
  geom_sf(fill= "antiquewhite") + 
  coord_sf(xlim = c(-125.00, -120.0), ylim = c(37.00, 41))+
  annotate(geom = "text", x = -124.3, y = 38.5, label = "Pacific Ocean", fontface = "italic", color = "grey22", size = 3.5) + 
  annotation_scale(location = "bl", width_hint = 0.5) + 
  annotation_north_arrow(location = "bl", which_north = "true", pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"), style = north_arrow_fancy_orienteering) + 
  xlab("Longitude") + 
  ylab("Latitude") + 
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed"), panel.background = element_rect(fill = "aliceblue"), axis.text.x = element_text(angle = 45, hjust = 1))

pt1
```





```{r}
NHD6 <- readOGR(dsn = "../additional/NHD_H_California_State_Shape/Shape/NHDFlowline_5.shp", stringsAsFactors = F)

NHD6.a <- as.data.frame(NHD6@data[["reachcode"]]) 
saveNHD6 <- NHD6.a %>% 
  mutate(reachcode = `NHD6@data[["reachcode"]]`) %>% 
  dplyr::select(reachcode) %>% 
  distinct() %>% 
  filter(str_detect(reachcode, "180201"))
testNHD6 <- NHD6 %>% subset(., reachcode %in% saveNHD6$reachcode)
ggNHD6 <-fortify(testNHD6)
```

```{r}

NHD4.a <- as.data.frame(NHD4@data[["ObjectID"]]) 
saveNHD4.a <- NHD4.a %>% 
  mutate(ObjectID = `NHD4@data[["ObjectID"]]`) %>% 
  dplyr::select(ObjectID) %>% 
  distinct() %>% 
  filter(ObjectID < 17000 & ObjectID > 13000)
testNHD4.a <- NHD4 %>% subset(., ObjectID %in% saveNHD4.a$ObjectID)
ggNHD4.a <-fortify(testNHD4.a)
```


```{r}
saveNHD1.2 <- as.data.frame(NHD1@data[["reachcode"]]) %>% 
  mutate(reachcode = NHD1@data[["reachcode"]]) %>% 
  dplyr::select(reachcode) %>% 
  distinct() %>% 
  filter(str_detect(reachcode, "18050001"))
testNHD1.2 <- NHD1 %>% subset(., reachcode %in% saveNHD1.2$reachcode)
ggNHD1.2 <-fortify(testNHD1.2) 

ggNHD1.3 <- ggNHD1.2 %>% 
  filter(group == "206.1")
```

```{r}
pt2 <- pt1 +
  #geom_polygon(data=ggNHD4_use, aes(x = long, y = lat, group=group), color = "darkblue", fill = "green3")+
  #geom_polygon(data=ggNHD4.a, aes(x = long, y = lat, group=group), color = "dodgerblue3", fill = "green")+
  geom_polygon(data=ggNHD1, aes(x = long, y = lat, group=group), color = "darkblue", fill = "aliceblue")+
  #geom_polygon(data=ggNHD1.2, aes(x = long, y = lat, group=group), color = "darkblue", fill = "aliceblue")+
  #geom_polygon(data=ggNHD1, aes(x = long, y = lat, group=group), fill = "dodgerblue")+
  #geom_polygon(data=ggNHD2, aes(x = long, y = lat, group=group), color = "dodgerblue")+
  #geom_polygon(data=ggNHD2, aes(x = long, y = lat, group=group), fill = "dodgerblue")+
  #geom_polygon(data=ggNHD3, aes(x = long, y = lat, group=group), color = "dodgerblue")+
  #geom_polygon(data=ggNHD3, aes(x = long, y = lat, group=group), fill = "dodgerblue")+
  geom_point(data = hatcheries, aes(x = long, y = lat, color=Hatchery), size=3)+
  geom_sf(fill= "transparent") + 
  coord_sf(xlim = c(-125.00, -120.0), ylim = c(37.00, 41))+
  annotate(geom = "text", x = -124.3, y = 38.5, label = "Pacific Ocean", fontface = "italic", color = "grey22", size = 3.5) + 
  annotation_scale(location = "bl", width_hint = 0.5) + 
  annotation_north_arrow(location = "bl", which_north = "true", pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"), style = north_arrow_fancy_orienteering) +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed"), panel.background = element_rect(fill = "aliceblue"), axis.text.x = element_text(angle = 45, hjust = 1))

pt2
```


```{r}
library(elevatr)
library(sf)
library(USAboundaries)

ca.poly <- us_states()%>%
  filter(state_name == "California")%>%
  st_transform(3310)

pts <- ca.poly%>%
  st_make_grid(10000)%>%
  st_centroid()%>%
  st_sf()%>%
  filter(st_intersects(., ca.poly, sparse = FALSE))

# Get elevation from USGS
e3 <- as.data.frame(get_elev_point(pts))
#> Warning: PROJ support is provided by the sf and terra packages among others
#> Downloading point elevations:
#> Note: Elevation units are in meters
pts$USGS_Meters <- e3$elevation

pts1 <- pts %>% 
  fill(USGS_Meters, .direction = "down")

# Plot 
ggplot(pts1)+
  geom_sf(aes(color = USGS_Meters), size = 1)+
  labs(title = "AWS Elevation - USGS Elevation [meters]",
       color = "Meters")+
  scale_color_gradient(low = "gray88",
  high = "gray30", guide = "colorbar",
  aesthetics = "color")
  #geom_polygon(data=ggNHD1, aes(x = long, y = lat, group=group), color = "darkblue", fill = "darkblue")#+
  #geom_point(data = hatcheries, aes(x = long, y = lat, color=Hatchery), size=3)
```

```{r}
library(remotes)
remotes::install_github("wmgeolab/rgeoboundaries")
```



```{r}
library(rgeoboundaries)
library(sf)
library(raster)
library(ggplot2)
library(viridis)
library(rnaturalearth)
library(rnaturalearthhires)
library(rnaturalearthdata)

usa_bound <- rgeoboundaries::geoboundaries("USA")
elevation_data <- elevatr::get_elev_raster(locations = usa_bound, z = 4, clip = "locations")

states <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE))
california <- states %>% 
  filter(ID == "california")

elevation_data <- as.data.frame(elevation_data, xy = TRUE)
colnames(elevation_data)[3] <- "elevation"
# remove rows of data frame with one or more NA's,using complete.cases
elevation_data <- elevation_data[complete.cases(elevation_data), ]

elevation_data1 <- elevation_data %>% 
  mutate(elevation = as.numeric(elevation)+4065)



a <-ggplot() +
  geom_raster(data = elevation_data, aes(x = x, y = y, fill = elevation)) +
  scale_fill_gradient(low = "lightyellow", high = "darkgreen", aesthetics = "fill")+
  geom_sf(data = usa_bound, color = "white", fill = NA) +
  coord_sf(xlim = c(-125.00, -120.0), ylim = c(37.00, 41))+
  labs(title = "Elevation in USA", x = "Longitude", y = "Latitude", fill = "Elevation (meters)")
a
```

```{r}
b <- a +
  geom_polygon(data=ggNHD1, aes(x = long, y = lat, group=group), color = "darkblue", fill = "darkblue")
b
```

```{r}
c <- b+
  geom_point(data = hatcheries, aes(x = long, y = lat, color=Hatchery), size=3)
c
```




```{r}
# hatchery locations
hatcheries <- data.frame(Hatchery = c("CH", "FRH", "MRH", "NH"),
                              lat = 
                           c(40.400914,39.518446,38.225070,38.633636),
                              long = 
                           c(-122.144753,-121.553234,-121.024417,
                                            -121.224950))
```

```{r}
NHD1 <- readOGR(dsn = "../additional/NHD_Major_Rivers_and_Creeks/NHD_Major_Rivers_and_Creeks.shp", stringsAsFactors = F)
```


```{r}
crks <- as.data.frame(NHD1@data[["gnis_name"]]) %>% 
  distinct()
saveNHD1 <- as.data.frame(NHD1@data[["gnis_name"]]) %>% 
  mutate(gnis_name = NHD1@data[["gnis_name"]]) %>% 
  dplyr::select(gnis_name) %>% 
  distinct() %>% 
  filter(str_detect(gnis_name, "American River|Fork Battle Creek|Feather River|Mokelumne River|Sacramento|San Joaquin")) %>% 
  filter(!str_detect(gnis_name, "Channel|Slough"))
testNHD1 <- NHD1 %>% subset(., gnis_name %in% saveNHD1$gnis_name)
ggNHD1 <-fortify(testNHD1)
```


```{r}
sf_usa <- ne_states(geounit = "United States of America", returnclass = "sf")
sf_ca <- sf_usa %>% 
  filter(abbrev == "Calif.")

elevation_1 <- elevatr::get_elev_raster(locations = sf_ca, z = 7, clip = "locations")
cropped_elev <- crop(elevation_1, sf_ca)
elevate <- as.data.frame(cropped_elev, xy = TRUE)

colnames(elevate)[3] <- "elevation_value"
elevate <- elevate[complete.cases(elevate), ]

a <-ggplot() +
  geom_raster(data = elevate, aes(x = x, y = y, fill = elevation_value)) +
  geom_sf(data = sf_ca, color = "white", fill = NA) +
  coord_sf(xlim = c(-125.00, -120.3), ylim = c(37.00, 41))+
  scale_fill_gradient(low = "gray90", high = "gray45", aesthetics = "fill")+
  labs(title = "", x = "", y = "", fill = "Elevation (meters)") +
  geom_polygon(data=ggNHD1, aes(x = long, y = lat, group=group), color = "dodgerblue")+
  geom_text(data = hatcheries, aes(long, lat, group = Hatchery, label=Hatchery), size = 4, fontface = "bold", nudge_x = c(-0.45,0.5,0.4,0.4), nudge_y = c(0, -0.1, -0.2, -0.1))+
  geom_point(data = hatcheries, aes(x = long, y = lat), size=3.25, color="black")+
  geom_point(data = hatcheries, aes(x = long, y = lat, color=Hatchery), size=3)+
  scale_color_manual(values = c("#9379AD", "#e4af62", "#b65d2b", "#79ad9f"))+
  annotate(geom = "text", x = -124.3, y = 38.5, label = "Pacific Ocean", fontface = "italic", color = "grey25", size = 3) +
  annotation_scale(location = "bl", width_hint = 0.35) + 
  annotation_north_arrow(location = "bl", which_north = "true", pad_x = unit(0.25, "in"), pad_y = unit(0.25, "in"), 
                         style = north_arrow_fancy_orienteering) +
  theme(panel.grid.major = element_line(color = gray(.9), linetype = "dashed"), 
        panel.background = element_rect(fill = "aliceblue"), axis.text.x = element_text(angle = 45, hjust = 1, size = 5),
        axis.text.y = element_text(size=5))+
  guides(shape = guide_legend(override.aes = list(size = 1)), color = guide_legend(override.aes = list(size = 1)))+
  theme(legend.title = element_text(size = 3), legend.text = element_text(size = 3), legend.key.size = unit(0.5, 'cm'))
```

```{r}
a
```

This is as good as it's probably going to get, so will clean up the rivers a little in Illustrator. The speckles under MRH will be removed, the Battle Creek forks will be connected to the CH dot, and where the Sacramento/San Joaquin rivers connect to the Pacific will be touched up. 


# Inset Map

```{r}
elevation_2 <- elevatr::get_elev_raster(locations = sf_usa, z = 1, clip = "locations")
cropped_elev2 <- crop(elevation_2, sf_usa)
elevate2 <- as.data.frame(cropped_elev2, xy = TRUE)

colnames(elevate2)[3] <- "elevation_value"
elevate2 <- elevate2[complete.cases(elevate2), ]

rectangle <- tibble(x=c(-124,-120.5,-120.5,-124),y=c(37.5, 37.5, 41, 41))

b <-ggplot() +
  geom_raster(data = elevate2, aes(x = x, y = y)) +
  geom_sf(data = sf_usa, color = "gray25", fill = "gray90") +
  coord_sf(xlim = c(-125.00, -65), ylim = c(25, 50))+
  labs(title = "", x = "", y = "") +
  theme(panel.grid.major = element_line(color = gray(.9), linetype = "dashed"), 
        panel.background = element_rect(fill = "aliceblue"), axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5))+
  geom_polygon(data=rectangle, aes(x=x,y=y), color="black", fill ="red")
b
```

It'll be easier to add the inset map to the map figure in Illustrator as well. 

```{r}
ggsave(plot=a, file="../figures/Fig1a_map.png", width = 20, height = 15, units = "cm", dpi = 800)
ggsave(plot=b, file="../figures/Fig1b_inset.png", width = 20, height = 15, units = "cm", dpi = 800)
```


